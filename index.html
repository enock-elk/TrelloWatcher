<!DOCTYPE html>
<!-- 
  CHANGELOG (Guardian Edition)
  --------------------------------------------------
  v2.2 (2026-01-22):
  - FEAT: Added Google Analytics 4 (GA4) integration.
  - FEAT: Added User Identification (via Trello Profile).
  - FEAT: Added Custom Events (Alert Type, Sounds, Bucket Count, Errors).
  v2.1 (2026-01-22):
  - REFACTOR: Moved polling logic to external Worker (js/worker.js).
  - FEAT: Added "Smart Grid" layout (3 buckets per row, auto-center remainder).
  - FEAT: Increased Max Bucket limit from 5 to 10.
  - FEAT: Enhanced divider card filtering (Training, Innovation, etc.).
  - FEAT: Added Microsoft Clarity analytics.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>TrelloWatcher</title>
    
    <!-- GOOGLE ANALYTICS (GA4) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-L20DL17QMT"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-L20DL17QMT');
    </script>

    <!-- ANALYTICS (CLARITY) -->
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "v55mwqxtkt");
    </script>

    <!-- PWA & ICON LINKS -->
    <link rel="icon" type="image/png" sizes="192x192" href="icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="icons/icon-512.png">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.85);
            --text-main: #f8fafc;
            --text-sub: #cbd5e1;
            --accent: #38bdf8;
            --accent-glow: rgba(56, 189, 248, 0.3);
            --danger: #ef4444;
            --success: #10b981;
            --border: rgba(255, 255, 255, 0.15);
            --input-bg: rgba(0, 0, 0, 0.3);
            --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            --backdrop-blur: blur(12px);
            --text-shadow-strong: 0 2px 4px rgba(0,0,0,0.95);
        }

        [data-theme="light"] {
            --bg-color: #f1f5f9;
            --card-bg: rgba(255, 255, 255, 0.85);
            --text-main: #0f172a;
            --text-sub: #475569;
            --accent: #0284c7;
            --accent-glow: rgba(2, 132, 199, 0.2);
            --danger: #dc2626;
            --success: #059669;
            --border: rgba(0, 0, 0, 0.1);
            --input-bg: rgba(255, 255, 255, 0.5);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --text-shadow-strong: none;
        }

        * { box-sizing: border-box; transition: background-color 0.3s, color 0.3s; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        body::before {
            content: "";
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.3);
            z-index: -1;
            pointer-events: none;
        }

        .container {
            width: 100%;
            max-width: 550px;
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-bottom: 80px;
            flex-grow: 1;
        }

        /* CLOCK STYLES */
        .clock-container {
            text-align: center;
            margin-bottom: 30px;
            padding-top: 40px;
            animation: fadeIn 0.8s ease-out;
            text-shadow: 0 4px 15px rgba(0,0,0,0.6);
        }
        .clock-time {
            font-size: 5rem;
            font-weight: 200; 
            line-height: 1;
            letter-spacing: -0.03em;
            color: #ffffff;
        }
        .clock-date {
            font-size: 1.3rem;
            color: rgba(255, 255, 255, 0.9);
            margin-top: 5px;
            font-weight: 400;
        }

        .header-row {
            text-align: center;
            margin-bottom: 20px;
            position: relative;
        }
        
        h1, .subtitle { text-shadow: var(--text-shadow-strong); }

        .card {
            background: var(--card-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            animation: fadeIn 0.4s ease-out;
            width: 100%;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .hidden { display: none !important; }

        /* --- LOGIN CARD --- */
        .login-card {
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            padding: 40px 25px;
        }
        .login-icon { font-size: 3rem; margin-bottom: 10px; }
        .login-desc { color: var(--text-sub); margin-bottom: 10px; line-height: 1.5; }
        .btn-trello {
            background: #0065FF;
            color: white;
            font-weight: 700;
            padding: 15px 30px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: transform 0.1s, background 0.2s;
            box-shadow: 0 4px 15px rgba(0, 101, 255, 0.3);
        }
        .btn-trello:hover { background: #0052CC; transform: translateY(-2px); }
        .btn-trello:active { transform: scale(0.98); }

        /* --- COMPACT MONITOR STYLES --- */
        .compact-monitor {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 95%;
            max-width: 600px;
            z-index: 100;
            padding: 15px 20px;
            display: flex;
            flex-direction: column; 
            gap: 10px;
            border-radius: 16px;
            margin-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            background: #1e293b; 
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            transition: all 0.3s ease;
        }

        .monitor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            font-weight: 800;
            color: var(--success);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .status-dot { 
            height: 8px; width: 8px; 
            background-color: var(--success); 
            border-radius: 50%; 
            display: inline-block; 
            box-shadow: 0 0 8px var(--success); 
            animation: pulse-green 2s infinite; 
        }

        .monitor-controls-group {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .sound-toggle-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: #94a3b8;
        }

        .monitor-text-row {
            text-align: center;
            width: 100%;
            color: #cbd5e1;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 5px;
        }
        .counter-highlight {
            color: var(--accent);
            font-size: 1.1rem;
            font-weight: 800;
            margin-right: 4px;
        }

        /* SMART FLEXBOX GRID (3 items per row, centered last row) */
        .bucket-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center; /* Centers the last row */
            gap: 10px;
            width: 100%;
            margin-top: 10px;
            max-height: 40vh;
            overflow-y: auto;
        }
        
        .bucket-card {
            background: rgba(255,255,255,0.07);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            transition: background 0.2s;
            width: 31%; /* Fits 3 per row with gap */
            min-width: 90px;
            flex-grow: 0; /* Do not stretch to fill space */
        }
        .bucket-card:hover {
            background: rgba(255,255,255,0.15);
        }

        .bucket-count {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--accent);
            line-height: 1;
            margin-bottom: 3px;
        }
        
        .bucket-name {
            font-size: 0.7rem;
            font-weight: 600;
            color: #cbd5e1;
            line-height: 1.1;
            word-break: break-word;
            display: -webkit-box;
            -webkit-line-clamp: 2; /* Truncate after 2 lines */
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .stop-btn-styled {
            background: rgba(220, 38, 38, 0.2);
            color: #ef4444;
            border: 1px solid #ef4444;
            padding: 6px 16px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.2s;
        }
        .stop-btn-styled:hover { background: #ef4444; color: white; }

        /* Inputs & Buttons */
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 0.85em; color: var(--text-sub); text-transform: uppercase; letter-spacing: 0.05em; }
        
        select {
            width: 100%; padding: 14px; background: var(--input-bg);
            border: 1px solid var(--border); color: var(--text-main);
            border-radius: 10px; font-size: 1rem; margin-bottom: 20px; outline: none;
        }
        select:focus { border-color: var(--accent); }

        .list-grid { display: flex; flex-direction: column; gap: 8px; max-height: 250px; overflow-y: auto; margin-bottom: 20px; padding: 4px; }
        .list-option {
            display: flex; align-items: center; padding: 12px;
            background: var(--input-bg); border: 1px solid var(--border);
            border-radius: 10px; cursor: pointer; transition: all 0.2s;
        }
        .list-option.selected { background: var(--accent-glow); border-color: var(--accent); font-weight: 600; }
        .list-option input { margin-right: 12px; transform: scale(1.2); accent-color: var(--accent); }

        .btn {
            width: 100%; padding: 16px; border: none; border-radius: 12px;
            font-size: 1rem; font-weight: 700; cursor: pointer;
            transition: transform 0.1s; text-transform: uppercase; letter-spacing: 0.02em;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--accent); color: white; box-shadow: 0 4px 12px var(--accent-glow); }
        
        /* Bottom Left Controls */
        .bottom-controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 90;
            transition: bottom 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            margin-bottom: env(safe-area-inset-bottom);
        }

        .icon-btn {
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text-main);
            padding: 10px 16px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            backdrop-filter: blur(5px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            min-width: 170px;
            text-align: center;
        }
        .icon-btn:hover { background: var(--input-bg); transform: translateY(-2px); }
        
        .install-btn-style {
            background: var(--accent);
            color: #fff;
            box-shadow: 0 4px 12px var(--accent-glow);
            border: none;
        }
        .install-btn-style:hover {
            filter: brightness(1.1);
        }

        /* --- SIDEBAR & MENU --- */
        .hamburger-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.1);
            border: 1px solid var(--border);
            color: var(--text-main);
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            backdrop-filter: blur(5px);
            z-index: 500;
            font-size: 1.5rem;
            transition: all 0.2s;
        }
        .hamburger-btn:hover { background: var(--accent); color: white; }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 280px;
            height: 100%;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-right: 1px solid var(--border);
            z-index: 1000;
            padding: 80px 20px 20px 20px;
            transform: translateX(-100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 10px 0 30px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .sidebar.open { transform: translateX(0); }
        
        .sidebar-header {
            font-size: 0.85em;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-sub);
            margin-bottom: 10px;
            font-weight: 700;
            padding-left: 5px;
        }

        .menu-item {
            padding: 16px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1em;
            color: var(--text-main);
            text-align: left;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }
        .menu-item:hover { background: var(--input-bg); }
        .menu-item span { font-size: 1.2em; }
        
        .menu-item.logout { color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.3); margin-top: auto; }
        .menu-item.logout:hover { background: rgba(239, 68, 68, 0.1); }

        .sidebar-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 900;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .sidebar-overlay.active { opacity: 1; pointer-events: all; }

        .setting-row {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 0; border-top: 1px solid var(--border); margin-top: 10px;
        }
        
        .mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        .mode-option {
            flex: 1;
            padding: 10px;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            font-size: 0.9rem;
            opacity: 0.7;
            transition: all 0.2s;
        }
        .mode-option.active {
            opacity: 1;
            border-color: var(--accent);
            background: var(--accent-glow);
            font-weight: bold;
        }
        .mode-option small {
            display: block;
            font-size: 0.7em;
            margin-top: 4px;
            opacity: 0.8;
        }

        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(100,100,100,0.4); transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success); }
        input:checked + .slider:before { transform: translateX(20px); }

        .status-dot { height: 8px; width: 8px; background-color: var(--success); border-radius: 50%; display: inline-block; box-shadow: 0 0 8px var(--success); animation: pulse-green 2s infinite; }
        
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 1500; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; animation: fadeIn 0.3s ease; }
        .overlay-content { max-width: 550px; width: 100%; max-height: 90vh; overflow-y: auto; position: relative; }
        
        .alarm-title { font-size: 3rem; font-weight: 900; color: var(--danger); margin-bottom: 10px; }
        .alarm-card-name { font-size: 2rem; color: #fff; font-weight: 700; margin-bottom: 40px; background: #1e293b; padding: 20px; border-radius: 12px; border: 2px solid var(--danger); }
        .btn-danger { background: var(--danger); color: white; padding: 20px 40px; font-size: 1.2rem; box-shadow: 0 0 30px rgba(239, 68, 68, 0.4); animation: pulse-red 1s infinite; }
        
        /* Volume HUD */
        #volumeHud {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(220, 220, 220, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 25px;
            border-radius: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            width: 200px;
            height: 200px;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
        }
        [data-theme="dark"] #volumeHud {
            background: rgba(30, 30, 30, 0.95);
            color: white;
        }
        .vol-icon { font-size: 3.5rem; margin-bottom: 15px; }
        .vol-text { font-weight: 800; font-size: 1.2rem; text-align: center; text-transform: uppercase; letter-spacing: 0.05em;}
        .vol-sub { font-size: 0.8rem; margin-top: 5px; opacity: 0.7; }
        .vol-bar { width: 100%; height: 6px; background: rgba(128,128,128,0.4); border-radius: 3px; margin-top: 15px; overflow: hidden; }
        .vol-fill { width: 100%; height: 100%; background: var(--accent); }

        /* General Message Modal */
        #messageOverlay {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
        }
        .msg-box {
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 30px;
            border-radius: 20px;
            max-width: 400px;
            width: 100%;
            box-shadow: var(--shadow);
            animation: popIn 0.3s ease;
        }
        .msg-title {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 10px;
            color: var(--accent);
        }
        .msg-body {
            font-size: 1rem;
            margin-bottom: 25px;
            color: var(--text-main);
            line-height: 1.5;
        }

        .app-footer {
            width: 100%;
            text-align: center;
            padding: 20px 0;
            margin-top: auto;
            font-size: 0.8rem;
            color: var(--text-sub);
            opacity: 0.8;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }
        .app-footer a {
            color: var(--text-main);
            text-decoration: underline;
            cursor: pointer;
            font-weight: 600;
        }
        .copyright {
            margin-top: 5px;
            font-size: 0.75rem;
            opacity: 0.6;
        }
        .footer-links {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 5px;
        }

        .legal-text {
            text-align: left;
            font-size: 0.9rem;
            color: var(--text-sub);
            line-height: 1.6;
            margin-bottom: 20px;
            background: var(--input-bg);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid var(--border);
        }
        .legal-text h3 { color: var(--text-main); margin-top: 0; margin-bottom: 10px; font-size: 1.1em; }
        .legal-text ul { padding-left: 20px; margin: 0; }
        .legal-text li { margin-bottom: 8px; }

        @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; } }

        @keyframes pulse-green { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }
        @keyframes pulse-red { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        body.alarm-active { animation: bg-flash 0.8s infinite; }
        @keyframes bg-flash { 0%, 100% { background-color: #0f172a; } 50% { background-color: #450a0a; } }

        .log-area { width: 100%; font-family: monospace; font-size: 0.8rem; color: var(--text-sub); margin-top: 20px; max-height: 100px; overflow-y: auto; opacity: 0.7; border-top: 1px solid var(--border); padding-top: 10px; text-shadow: 1px 1px 1px black; }
        .log-error { color: var(--danger); font-weight: bold; }

        @media (max-width: 600px) {
            .clock-time { font-size: 3.5rem; }
            .clock-date { font-size: 1.1rem; }
            body.monitoring-active .bottom-controls { bottom: 140px; }
            
            /* Compact monitor mobile adjustments */
            .monitor-header { margin-bottom: 8px; }
            
            /* Responsive Grid for mobile */
            .bucket-grid {
                grid-template-columns: 1fr 1fr; /* 2 col on mobile */
                max-height: 35vh;
            }
            .bucket-card { width: 48%; } /* 2 per row */
        }
    </style>
</head>
<body>

<!-- SIDEBAR NAVIGATION -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
<div id="sideNav" class="sidebar">
    <div class="sidebar-header">Preferences</div>
    
    <div class="menu-item" onclick="triggerBgUpload()">
        <span>üìÇ</span> Upload Background
    </div>
    <div class="menu-item" onclick="setTheme('light')">
        <span>‚òÄÔ∏è</span> Light Mode
    </div>
    <div class="menu-item" onclick="setTheme('dark')">
        <span>üåô</span> Dark Mode
    </div>
    <div class="menu-item" onclick="resetWallpaper()">
        <span>‚Ü∫</span> Reset Defaults
    </div>

    <!-- LOGOUT BUTTON -->
    <div class="menu-item logout" onclick="handleLogout()">
        <span>üö™</span> Logout
    </div>

    <!-- Hidden Input for file upload -->
    <input type="file" id="bgInput" accept="image/*" style="display:none;" onchange="handleBgUpload(this)">
</div>

<!-- HAMBURGER BUTTON -->
<button class="hamburger-btn" onclick="toggleSidebar()">
    ‚ò∞
</button>

<div class="container">
    
    <!-- CLOCK -->
    <div class="clock-container">
        <div id="clockTime" class="clock-time">--:--</div>
        <div id="clockDate" class="clock-date">loading...</div>
    </div>

    <!-- MAIN TITLE -->
    <div class="header-row">
        <h1>TrelloWatcher</h1>
        <div class="subtitle">List Activity Monitor</div>
    </div>

    <!-- STEP 0: LOGIN -->
    <div id="loginSection" class="card login-card hidden">
        <div class="login-icon">üîê</div>
        <h2>Authentication Required</h2>
        <div class="login-desc">
            To securely monitor your private boards, you need to authorize this app with Trello.
            <br><br>
            <small style="opacity:0.7">This connection happens directly between your browser and Trello.</small>
        </div>
        <button class="btn-trello" onclick="authorizeTrello()">
            <span>Authorize with Trello</span>
        </button>
    </div>

    <!-- STEP 1: LOAD -->
    <div id="loadingSection" class="card hidden" style="text-align: center;">
        <div class="status-dot" style="background: var(--text-sub); animation: none;"></div>
        <p>Connecting to Trello...</p>
    </div>

    <!-- STEP 2: SETUP -->
    <div id="setupSection" class="card hidden">
        <label>1. Select Board</label>
        <select id="boardSelect" onchange="handleBoardChange(this)"></select>
        
        <label>2. Select Buckets (Max 10)</label>
        <div class="list-grid" id="listCheckboxes">
            <div style="padding: 20px; text-align: center; color: var(--text-sub);">Select a board above.</div>
        </div>

        <label>3. Alert Mode</label>
        <div class="mode-selector">
            <div class="mode-option active" id="modeWake" onclick="setAlertMode('wake', true)">
                üö® Wake Me Up
                <small>Continuous Loop</small>
            </div>
            <div class="mode-option" id="modeNotify" onclick="setAlertMode('notify', true)">
                üîî Notification
                <small>One-time Chime</small>
            </div>
        </div>

        <div class="setting-row">
            <div class="setting-label"><span>üîä</span> Sound Enabled</div>
            <label class="switch">
                <input type="checkbox" id="soundToggle" checked>
                <span class="slider"></span>
            </label>
        </div>

        <div class="setting-row">
            <div class="setting-label"><span>üéµ</span> Alert Tone</div>
            <div style="display:flex; width: 60%; align-items:center; gap: 5px;">
                <select id="toneSelect" onchange="handleToneChange(this)" style="margin-bottom:0; flex-grow:1;">
                    <option value="default">Default Siren</option>
                    <option value="sounds/message_tone.mp3">Message Tone</option>
                    <option value="sounds/message_messaaaaaage.mp3">Message... Message!</option>
                    <option value="sounds/message_my_lord.mp3">Message My Lord</option>
                    <option value="sounds/email_notification.mp3">Email Notification</option>
                    <option value="sounds/bottle_opener.mp3">Bottle Opener</option>
                    <option value="sounds/carlock.mp3">Car Lock</option>
                    <option value="sounds/doorbell.mp3">Doorbell</option>
                    
                    <!-- NEW SOUNDS ADDED HERE -->
                    <option value="sounds/zap.mp3">Zap</option>
                    <option value="sounds/just_calledf__k_u.mp3">Just Called...</option>
                    <option value="sounds/ping.mp3">Ping</option>
                    <option value="sounds/notification.mp3">Simple Notification</option>
                    <option value="sounds/sneeze.mp3">Sneeze</option>
                    <option value="sounds/wahwahwahwahhh.mp3">Wah Wah Wah</option>
                    
                    <option value="custom">Custom Upload...</option>
                </select>
                
                <!-- SMART TEST BUTTON -->
                <button id="testBtn" class="mini-stop-btn" style="padding: 10px 12px; background: var(--accent); color: white; border: none; width: 44px;" onclick="toggleTestSound()">
                    ‚ñ∂
                </button>
            </div>
            
            <div id="customSoundStatus" style="font-size:0.8em; color:var(--text-sub); display:none; margin-left:10px;">
                Custom Loaded
            </div>
            <input type="file" id="soundInput" accept="audio/*" class="hidden" onchange="handleSoundUpload(this)">
        </div>

        <button class="btn btn-primary" onclick="startMonitoring()">Start Watching</button>
    </div>

    <!-- STEP 3: COMPACT MONITOR -->
    <div id="monitorSection" class="compact-monitor hidden">
        <!-- Top Row: Active Status & Controls -->
        <div class="monitor-header">
            <div class="status-badge">
                <div class="status-dot"></div>
                <span>ACTIVE</span>
            </div>

            <div class="monitor-controls-group">
                <div class="sound-toggle-wrapper">
                    <span>Sound</span>
                    <label class="switch" style="transform:scale(0.8);">
                        <input type="checkbox" id="soundToggleActive" checked onchange="syncToggles()">
                        <span class="slider"></span>
                    </label>
                </div>
                <button class="stop-btn-styled" onclick="stopMonitoring()">STOP</button>
            </div>
        </div>

        <!-- Middle: Card Counter Text -->
        <div class="monitor-text-row">
            <span id="totalCards" class="counter-highlight">0</span> Cases in total in:
        </div>

        <!-- Bottom: NEW GRID LAYOUT -->
        <div id="watchedListContainer" class="bucket-grid">
            <!-- Grid items generated by JS -->
        </div>
    </div>

    <div class="log-area" id="logArea"></div>

    <!-- FOOTER -->
    <div class="app-footer">
        <div class="footer-links">
            <a onclick="toggleTerms()">Terms of Use</a>
            <span style="color:var(--text-sub);">|</span>
            <a onclick="togglePrivacy()">Privacy Policy</a>
        </div>
        <div class="copyright">2025 ¬© Kazembe CodeWorks. All rights reserved</div>
    </div>
</div>

<!-- BOTTOM LEFT CONTROLS -->
<div class="bottom-controls">
    <button id="installBtn" class="icon-btn install-btn-style hidden" onclick="installApp()">
        ‚¨áÔ∏è Install App
    </button>
</div>

<!-- GENERIC MESSAGE OVERLAY -->
<div id="messageOverlay" class="overlay hidden">
    <div class="msg-box">
        <div id="msgTitle" class="msg-title">Notice</div>
        <div id="msgBody" class="msg-body">Message goes here.</div>
        <button class="btn btn-primary" onclick="closeMessage()">OK</button>
    </div>
</div>

<!-- TERMS OVERLAY -->
<div id="termsOverlay" class="overlay hidden">
    <div class="overlay-content">
        <h1>Terms of Use</h1>
        <div class="legal-text">
            <h3>‚ö†Ô∏è Critical Usage Rules</h3>
            <ul>
                <li><strong>Do Not Minimize:</strong> This app runs in your browser. If you minimize the window, the browser will "throttle" the app and stop checking for alerts to save battery. Keep this window visible on your screen or a second monitor.</li>
                <li><strong>Check Volume:</strong> This web app cannot access your system's master volume settings. Please manually ensure your speakers are turned on and not muted.</li>
                <li><strong>Enable Audio:</strong> Browsers block auto-playing sound. You must interact with the page (click "Start Watching") for the alarm to function correctly.</li>
                <li><strong>Power:</strong> The app keeps the screen awake. Please plug in your device.</li>
            </ul>
        </div>
        <button class="btn btn-primary" onclick="toggleTerms()">Close</button>
    </div>
</div>

<!-- PRIVACY OVERLAY -->
<div id="privacyOverlay" class="overlay hidden">
    <div class="overlay-content">
        <h1>Privacy Policy</h1>
        <div class="legal-text">
            <h3>üîí Your Data is Safe</h3>
            <ul>
                <li><strong>Local Operation:</strong> TrelloWatcher runs entirely within your browser (Client-Side).</li>
                <li><strong>No Data Collection:</strong> We do not track you, use cookies for analytics, or collect any personal data.</li>
                <li><strong>Credentials:</strong> Your API Key and Token are stored in the code and sent directly to Trello. They are never sent to Kazembe CodeWorks or any third-party server.</li>
                <li><strong>Local Storage:</strong> Custom backgrounds and alert tones are saved in your browser's local storage and never uploaded to the cloud.</li>
            </ul>
        </div>
        <button class="btn btn-primary" onclick="togglePrivacy()">Close</button>
    </div>
</div>

<!-- ALARM OVERLAY -->
<div id="alarmOverlay" class="overlay hidden" style="background:var(--bg-color);">
    <div class="alarm-title">üö® Alert üö®</div>
    <div style="color:#cbd5e1; margin-bottom:10px;">Incoming to: <span id="alarmListName" style="color:var(--accent); font-weight:bold;">List</span></div>
    <div class="alarm-card-name" id="newCardName">Card Name</div>
    <button class="btn btn-danger" onclick="stopAlarm()">ACKNOWLEDGE</button>
</div>

<!-- VOLUME HUD (Hidden by default) -->
<div id="volumeHud" class="hidden">
    <div class="vol-icon">üîä</div>
    <div class="vol-text">Is Sound On?</div>
    <div class="vol-sub">Check system volume</div>
    <div class="vol-bar"><div class="vol-fill"></div></div>
</div>

<script>
    // --- APP CONSTANTS ---
    const API_KEY = '4a2f87929257d1557d800be137588c07'; // Public App Key
    const MAX_BUCKETS = 10; // UPDATED LIMIT
    
    // --- STORAGE KEYS ---
    const PREF_TOKEN = 'watcher_trello_token';
    const PREF_BOARD_ID = 'watcher_board_id';
    const PREF_BUCKET_IDS = 'watcher_bucket_ids';
    const PREF_MODE = 'watcher_mode';
    const PREF_TONE_WAKE = 'watcher_tone_wake';
    const PREF_TONE_NOTIFY = 'watcher_tone_notify';

    // --- STATE VARIABLES ---
    let userToken = null;
    let worker = null; // Web Worker Instance
    let isAlarmPlaying = false;
    let isTesting = false; 
    let audioCtx = null;
    let oscillator = null;
    let wakeLock = null;
    let alertMode = 'wake'; 
    let alarmTimeout1 = null;
    let alarmTimeout2 = null;
    let alarmTimeout3 = null;
    let currentUser = null; // Store Trello User Info
    
    // Custom Audio Variables
    let customAudioSource = null;
    let customAudio = null;

    // --- DOM ELEMENTS ---
    const loginSection = document.getElementById('loginSection');
    const loadingSection = document.getElementById('loadingSection');
    const setupSection = document.getElementById('setupSection');
    const monitorSection = document.getElementById('monitorSection');
    const alarmOverlay = document.getElementById('alarmOverlay');
    const termsOverlay = document.getElementById('termsOverlay');
    const privacyOverlay = document.getElementById('privacyOverlay');
    const messageOverlay = document.getElementById('messageOverlay');
    
    const sideNav = document.getElementById('sideNav');
    const sidebarOverlay = document.getElementById('sidebarOverlay');

    const volumeHud = document.getElementById('volumeHud');
    const logArea = document.getElementById('logArea');
    const soundToggle = document.getElementById('soundToggle');
    const soundToggleActive = document.getElementById('soundToggleActive');
    const clockTime = document.getElementById('clockTime');
    const clockDate = document.getElementById('clockDate');
    
    const toneSelect = document.getElementById('toneSelect');
    const customSoundStatus = document.getElementById('customSoundStatus');
    const testBtn = document.getElementById('testBtn');
    const installBtn = document.getElementById('installBtn');
    let deferredPrompt;

    // --- INITIALIZATION ---
    window.onload = async () => {
        initVisuals();
        
        // Check for token in URL (redirect from Trello)
        const hash = window.location.hash.substring(1);
        const params = new URLSearchParams(hash);
        
        if (params.has('token')) {
            userToken = params.get('token');
            localStorage.setItem(PREF_TOKEN, userToken);
            // Clean URL so token doesn't sit in history
            window.history.replaceState({}, document.title, window.location.pathname);
            
            // ANALYTICS: Track Login Event
            gtag('event', 'login', { method: 'trello_oauth' });
        } else {
            userToken = localStorage.getItem(PREF_TOKEN);
        }

        if (!userToken) {
            // Show Login
            loginSection.classList.remove('hidden');
        } else {
            // Show App
            initAppWithToken();
        }

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('./sw.js')
            .then(reg => {
                console.log('SW Registered');
                reg.onupdatefound = () => {
                   const installingWorker = reg.installing;
                   installingWorker.onstatechange = () => {
                     if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                       log("New update available. Refresh to apply.", false);
                     }
                   };
                };
            })
            .catch(console.error);
        }
    };

    // --- AUTH LOGIC ---
    function authorizeTrello() {
        const returnUrl = window.location.href;
        const scope = 'read';
        const expiration = 'never';
        const name = 'TrelloWatcher';
        const authUrl = `https://trello.com/1/authorize?expiration=${expiration}&name=${name}&scope=${scope}&response_type=token&key=${API_KEY}&return_url=${encodeURIComponent(returnUrl)}`;
        window.location.href = authUrl;
    }

    function handleLogout() {
        // ANALYTICS: Log logout
        gtag('event', 'logout', {
            event_category: 'User',
            event_label: currentUser ? currentUser.fullName : 'Unknown'
        });

        localStorage.removeItem(PREF_TOKEN);
        userToken = null;
        currentUser = null;
        stopMonitoring();
        toggleSidebar();
        setupSection.classList.add('hidden');
        monitorSection.classList.add('hidden');
        loginSection.classList.remove('hidden');
        showMessage("Logged Out", "You have been logged out securely.");
    }

    // --- APP STARTUP ---
    async function initAppWithToken() {
        loginSection.classList.add('hidden');
        loadingSection.classList.remove('hidden');

        // Init Mode & Tone defaults
        const savedMode = localStorage.getItem(PREF_MODE);
        if (savedMode) {
            setAlertMode(savedMode, false);
            const savedTone = (savedMode === 'wake') 
                ? (localStorage.getItem(PREF_TONE_WAKE) || 'default')
                : (localStorage.getItem(PREF_TONE_NOTIFY) || 'sounds/message_my_lord.mp3');
            toneSelect.value = savedTone;
            updateToneUI(savedTone);
        } else {
            setAlertMode('wake', false);
            toneSelect.value = 'default';
            updateToneUI('default');
            localStorage.setItem(PREF_TONE_WAKE, 'default');
            localStorage.setItem(PREF_TONE_NOTIFY, 'sounds/message_my_lord.mp3');
        }

        try { 
            await identifyUser(); // NEW: Identify user for Analytics
            await fetchBoards(); 
        } catch (e) { 
            log("Init Error: " + e.message, true);
            gtag('event', 'error', { 
                event_category: 'Initialization', 
                event_label: e.message 
            });
            if(e.message.includes('401') || e.message.includes('Unauthorized')) {
                handleLogout();
                showMessage("Session Expired", "Your Trello session expired. Please log in again.");
            }
        }
    }

    // --- TRELLO API ---
    async function trelloFetchMain(url) {
        if (!userToken) throw new Error("No Token");
        const response = await fetch(`${url}?key=${API_KEY}&token=${userToken}`);
        if (response.status === 401) throw new Error('Unauthorized');
        if (!response.ok) throw new Error('API Error');
        return await response.json();
    }

    // NEW: Fetch User Profile
    async function identifyUser() {
        try {
            const member = await trelloFetchMain('https://api.trello.com/1/members/me');
            currentUser = member;
            
            // ANALYTICS: Set User ID
            gtag('config', 'G-L20DL17QMT', {
                'user_id': member.id
            });
            
            // Log for debugging
            console.log("Logged in as:", member.fullName);
            
        } catch(e) {
            console.warn("Could not fetch user profile", e);
        }
    }

    async function fetchBoards() {
        const boards = await trelloFetchMain('https://api.trello.com/1/members/me/boards');
        const boardSelect = document.getElementById('boardSelect');
        boardSelect.innerHTML = '<option value="">-- Choose a Board --</option>';
        
        let targetBoardId = localStorage.getItem(PREF_BOARD_ID);
        let found = false;

        boards.forEach(b => {
            const opt = document.createElement('option');
            opt.value = b.id; 
            opt.innerText = b.name; 
            boardSelect.appendChild(opt);

            if (targetBoardId && b.id === targetBoardId) {
                opt.selected = true;
                found = true;
            } else if (!targetBoardId && b.name.toLowerCase().includes("actuarial reports")) {
                opt.selected = true;
                targetBoardId = b.id;
                found = true;
                localStorage.setItem(PREF_BOARD_ID, b.id);
            }
        });
        
        loadingSection.classList.add('hidden');
        setupSection.classList.remove('hidden');

        if (found) {
            fetchLists();
        }
    }

    async function fetchLists() {
        const boardId = document.getElementById('boardSelect').value;
        if (!boardId) return;
        
        const lists = await trelloFetchMain(`https://api.trello.com/1/boards/${boardId}/lists`);
        const container = document.getElementById('listCheckboxes');
        container.innerHTML = '';

        const savedBuckets = JSON.parse(localStorage.getItem(PREF_BUCKET_IDS) || '[]');

        lists.forEach(l => {
            const div = document.createElement('label');
            div.className = 'list-option';
            
            const isChecked = savedBuckets.includes(l.id) ? 'checked' : '';
            if (isChecked) div.classList.add('selected');

            div.innerHTML = `<input type=\"checkbox\" name=\"bucket\" value=\"${l.id}\" data-name=\"${l.name}\" ${isChecked} onchange=\"handleSelectionLimit(this)\"><span>${l.name}</span>`;
            container.appendChild(div);
        });
    }

    // --- MONITORING LOGIC ---
    async function startMonitoring() {
        const boardId = document.getElementById('boardSelect').value;
        const checkboxes = document.querySelectorAll('input[name="bucket"]:checked');

        if (!boardId) { showMessage("Action Required", "Please select a board to watch!"); return; }
        if (checkboxes.length === 0) { showMessage("Action Required", "Please select a list to watch!"); return; }

        // Audio Context Start (User Interaction)
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!audioCtx) audioCtx = new AudioContext();
        if (audioCtx.state === 'suspended') await audioCtx.resume();
        
        if ("Notification" in window && Notification.permission !== "granted") {
            Notification.requestPermission();
        }

        showVolumeCheck();
        requestWakeLock();

        const targets = Array.from(checkboxes).map(cb => ({ id: cb.value, name: cb.getAttribute('data-name') }));

        // ANALYTICS: Track Monitoring Start
        gtag('event', 'start_monitoring', {
            'board_id': boardId,
            'bucket_count': targets.length,
            'alert_mode': alertMode,
            'alert_sound': toneSelect.value
        });

        setupSection.classList.add('hidden');
        monitorSection.classList.remove('hidden');
        document.body.classList.add('monitoring-active');
        
        // Initial Empty Render of Grid
        renderBucketGrid(targets.map(t => ({...t, count: '-'})));

        // START EXTERNAL WORKER
        worker = new Worker('js/worker.js');
        
        // Set up Worker Listeners
        worker.onmessage = (e) => {
            const data = e.data;
            if (data.type === 'log') log(data.msg);
            
            else if (data.type === 'error') {
                log("Error: " + data.msg, true);
                // ANALYTICS: Track Worker Errors
                gtag('event', 'error', { 'event_category': 'Worker', 'event_label': data.msg });
            }
            
            else if (data.type === 'auth_fail') { stopMonitoring(); handleLogout(); }
            
            // NEW: Receive Structured Buckets
            else if (data.type === 'stats') { 
                document.getElementById('totalCards').innerText = data.total;
                if (data.buckets) renderBucketGrid(data.buckets);
            }
            
            else if (data.type === 'alarm') {
                if (soundToggleActive.checked && !isAlarmPlaying) {
                    triggerAlarm(data.cardName, data.listName);
                }
            }
        };

        // Start Worker
        worker.postMessage({ 
            cmd: 'start', 
            payload: { apiKey: API_KEY, token: userToken, targets: targets }
        });

        log(`Started monitoring: ${targets.map(t => t.name).join(', ')}`);
    }

    // --- NEW: RENDER GRID ---
    function renderBucketGrid(buckets) {
        const container = document.getElementById('watchedListContainer');
        container.innerHTML = '';
        
        buckets.forEach(b => {
            const card = document.createElement('div');
            card.className = 'bucket-card';
            card.innerHTML = `
                <div class="bucket-count">${b.count}</div>
                <div class="bucket-name">${b.name}</div>
            `;
            container.appendChild(card);
        });
    }

    function stopMonitoring() {
        if (worker) {
            worker.postMessage({ cmd: 'stop' });
            worker.terminate();
            worker = null;
        }
        monitorSection.classList.add('hidden');
        setupSection.classList.remove('hidden');
        document.body.classList.remove('monitoring-active');
        if (wakeLock) { wakeLock.release().then(() => { wakeLock = null; }); }
        log("Monitoring stopped.");
    }

    async function requestWakeLock() {
        try { if ('wakeLock' in navigator) { wakeLock = await navigator.wakeLock.request('screen'); } } catch (err) {}
    }

    // --- ALARM LOGIC ---
    function triggerAlarm(cardName, listName) {
        isAlarmPlaying = true;
        document.body.classList.add('alarm-active');
        
        alarmOverlay.classList.remove('hidden');
        document.getElementById('newCardName').innerText = cardName;
        document.getElementById('alarmListName').innerText = listName;
        log(`ALARM: New card in ${listName}`);

        // ANALYTICS: Track Alarm Trigger
        gtag('event', 'alarm_triggered', {
            'list_name': listName,
            'alert_mode': alertMode,
            'alert_sound': toneSelect.value
        });

        if ("Notification" in window && Notification.permission === "granted" && document.visibilityState !== "visible") {
            try {
                new Notification("Trello Alert!", {
                    body: `New card in ${listName}: ${cardName}`,
                    icon: 'icons/icon-192.png',
                    tag: 'trello-alert',
                    renotify: true,
                    vibrate: [200, 100, 200]
                });
            } catch(e) { console.log("Notification failed", e); }
        }

        if (navigator.vibrate) {
            if(alertMode === 'wake') navigator.vibrate([500, 200, 500, 200, 1000]);
            else navigator.vibrate(200);
        }

        const shouldLoop = (alertMode === 'wake');
        playAudio(shouldLoop);

        if (alertMode === 'wake') {
            alarmTimeout1 = setTimeout(() => {
                log("Alarm paused (Safety 1)");
                stopSoundOnly(); 
                alarmTimeout2 = setTimeout(() => {
                    log("Alarm resuming");
                    playAudio(true); 
                    alarmTimeout3 = setTimeout(() => {
                        log("Alarm stopped (Safety Cutoff)");
                        stopAlarm(); 
                    }, 180000);
                }, 30000); 
            }, 180000); 
        } else {
             setTimeout(() => { if(isAlarmPlaying) stopAlarm(); }, 5000);
        }
    }

    function playAudio(loop) {
        stopSoundOnly();

        if (audioCtx && audioCtx.state === 'suspended') {
            audioCtx.resume().then(() => {
               // resumed
            });
        }

        if (customAudioSource) {
            customAudio = new Audio(customAudioSource);
            customAudio.loop = loop; 
            
            const playPromise = customAudio.play();
            if (playPromise !== undefined) {
                playPromise.catch(e => {
                    if (e.name === 'AbortError') return;
                    log("Audio Failed: " + e.message, true);
                    playSynth(loop);
                });
            }
            return;
        }
        playSynth(loop);
    }

    function playSynth(loop) {
        try {
            if (audioCtx.state === 'suspended') audioCtx.resume();

            oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain(); 
            oscillator.connect(gainNode); 
            gainNode.connect(audioCtx.destination); 
            
            if (loop) {
                gainNode.gain.value = 0.15; 
                oscillator.type = 'sawtooth'; 
                oscillator.frequency.setValueAtTime(440, audioCtx.currentTime); 
                oscillator.start(); 
                oscillator.frequency.linearRampToValueAtTime(880, audioCtx.currentTime + 0.5);
                const lfo = audioCtx.createOscillator(); 
                lfo.type = 'sine'; lfo.frequency.value = 2; 
                const lfoGain = audioCtx.createGain(); lfoGain.gain.value = 300;
                lfo.connect(lfoGain); lfoGain.connect(oscillator.frequency); 
                lfo.start();
            } else {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(440, audioCtx.currentTime); 
                gainNode.gain.setValueAtTime(0.15, audioCtx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 1);
                oscillator.start(); 
                oscillator.stop(audioCtx.currentTime + 1); 
                oscillator.onended = () => { oscillator = null; };
            }
        } catch (e) { log("Synth Error: " + e.message, true); }
    }

    function stopSoundOnly() {
        if (customAudio) { try { customAudio.pause(); customAudio.currentTime = 0; } catch(e){} customAudio = null; }
        if (oscillator) { try { oscillator.stop(); oscillator.disconnect(); } catch(e){} oscillator = null; }
    }

    function stopAlarm() {
        isAlarmPlaying = false;
        clearTimeout(alarmTimeout1); clearTimeout(alarmTimeout2); clearTimeout(alarmTimeout3);
        document.body.classList.remove('alarm-active');
        alarmOverlay.classList.add('hidden');
        volumeHud.classList.add('hidden'); 
        isTesting = false;
        testBtn.innerText = "‚ñ∂"; testBtn.style.background = "var(--accent)";
        if (navigator.vibrate) navigator.vibrate(0);
        stopSoundOnly();
    }

    // --- UI HELPERS ---
    function updateClock() {
        const now = new Date();
        let hours = now.getHours();
        const minutes = now.getMinutes().toString().padStart(2, '0');
        const ampm = hours >= 12 ? 'PM' : 'AM';
        hours = hours % 12; hours = hours ? hours : 12; 
        clockTime.innerText = `${hours.toString().padStart(2, '0')}:${minutes} ${ampm}`;
        const options = { weekday: 'long', day: 'numeric', month: 'long' };
        clockDate.innerText = now.toLocaleDateString('en-GB', options);
    }
    updateClock(); setInterval(updateClock, 1000);

    function initVisuals() {
        const savedTheme = localStorage.getItem('watcher_theme');
        if (!savedTheme || savedTheme === 'dark') document.documentElement.setAttribute('data-theme', 'dark');
        else document.documentElement.setAttribute('data-theme', 'light');
        const savedBg = localStorage.getItem('watcher_bg');
        if (savedBg) document.body.style.backgroundImage = `url(${savedBg})`;
    }

    function setTheme(mode) {
        document.documentElement.setAttribute('data-theme', mode);
        localStorage.setItem('watcher_theme', mode);
        toggleSidebar(); 
    }

    function toggleSidebar() { sideNav.classList.toggle('open'); sidebarOverlay.classList.toggle('active'); }
    function toggleTerms() { termsOverlay.classList.toggle('hidden'); }
    function togglePrivacy() { privacyOverlay.classList.toggle('hidden'); }
    
    function showMessage(title, body) {
        document.getElementById('msgTitle').innerText = title;
        document.getElementById('msgBody').innerText = body;
        messageOverlay.classList.remove('hidden');
    }
    function closeMessage() { messageOverlay.classList.add('hidden'); }

    function triggerBgUpload() { document.getElementById('bgInput').click(); }
    function handleBgUpload(input) {
        if (input.files && input.files[0]) {
            if(input.files[0].size > 4 * 1024 * 1024) { showMessage("Error", "Max 4MB."); return; }
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    localStorage.setItem('watcher_bg', e.target.result);
                    document.body.style.backgroundImage = `url(${e.target.result})`;
                    toggleSidebar(); 
                } catch (err) { showMessage("Error", "Storage full."); }
            };
            reader.readAsDataURL(input.files[0]);
        }
    }
    function resetWallpaper() {
        localStorage.removeItem('watcher_bg');
        document.body.style.backgroundImage = '';
        toggleSidebar(); 
    }

    function handleToneChange(select) {
        const value = select.value;
        if (alertMode === 'wake') localStorage.setItem(PREF_TONE_WAKE, value);
        else localStorage.setItem(PREF_TONE_NOTIFY, value);
        updateToneUI(value);
        
        // PRELOAD / CHECK SOUND
        if(value !== 'default' && value !== 'custom') {
            const tempAudio = new Audio(value);
            tempAudio.load(); 
        }
    }

    function updateToneUI(value) {
        if (value === 'default') { customAudioSource = null; customSoundStatus.style.display = 'none'; }
        else if (value === 'custom') {
            const saved = localStorage.getItem('watcher_custom_sound');
            if (saved) { customAudioSource = saved; customSoundStatus.style.display = 'inline'; }
            else { document.getElementById('soundInput').click(); }
        } else { customAudioSource = value; customSoundStatus.style.display = 'none'; }
    }

    function handleSoundUpload(input) {
        if (input.files && input.files[0]) {
            if(input.files[0].size > 2 * 1024 * 1024) { showMessage("Error", "Max 2MB."); toneSelect.value = 'default'; return; }
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    localStorage.setItem('watcher_custom_sound', e.target.result);
                    customAudioSource = e.target.result;
                    customSoundStatus.style.display = 'inline';
                    customSoundStatus.innerText = "Uploaded!";
                } catch (err) { showMessage("Error", "Storage full."); toneSelect.value = 'default'; }
            };
            reader.readAsDataURL(input.files[0]);
        } else { toneSelect.value = 'default'; }
    }

    function toggleTestSound() {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        if (!audioCtx) audioCtx = new AudioContext();
        if (audioCtx.state === 'suspended') audioCtx.resume();

        if (isTesting || isAlarmPlaying) { stopAlarm(); } 
        else {
            isTesting = true;
            testBtn.innerText = "‚èπ"; testBtn.style.background = "var(--danger)";
            
            // ANALYTICS: Track Sound Test
            gtag('event', 'sound_test', {
                'sound_name': toneSelect.value
            });

            const shouldLoop = (alertMode === 'wake');
            playAudio(shouldLoop);
            if (!shouldLoop) { setTimeout(() => { if(isTesting) { isTesting = false; testBtn.innerText = "‚ñ∂"; testBtn.style.background = "var(--accent)"; } }, 4000); }
        }
    }

    function setAlertMode(mode, fromUserClick = false) {
        alertMode = mode;
        const wakeBtn = document.getElementById('modeWake');
        const notifyBtn = document.getElementById('modeNotify');
        
        if (mode === 'wake') { wakeBtn.classList.add('active'); notifyBtn.classList.remove('active'); } 
        else { notifyBtn.classList.add('active'); wakeBtn.classList.remove('active'); }

        if (fromUserClick) {
            localStorage.setItem(PREF_MODE, mode);
            let newTone = (mode === 'wake') ? (localStorage.getItem(PREF_TONE_WAKE) || 'default') : (localStorage.getItem(PREF_TONE_NOTIFY) || 'sounds/message_my_lord.mp3');
            toneSelect.value = newTone;
            updateToneUI(newTone);
            
            // ANALYTICS: Track Mode Change
            gtag('event', 'mode_change', {
                'new_mode': mode
            });

            if(mode === 'notify' && !localStorage.getItem(PREF_TONE_NOTIFY)) localStorage.setItem(PREF_TONE_NOTIFY, 'sounds/message_my_lord.mp3');
        }
    }

    function handleBoardChange(select) {
        if(select.value) { localStorage.setItem(PREF_BOARD_ID, select.value); fetchLists(); }
    }

    function handleSelectionLimit(checkbox) {
        const checked = document.querySelectorAll('input[name="bucket"]:checked');
        if (checked.length > MAX_BUCKETS) { checkbox.checked = false; showMessage("Limit", `Max ${MAX_BUCKETS} buckets.`); return; }
        const currentSelection = Array.from(document.querySelectorAll('input[name="bucket"]:checked')).map(cb => cb.value);
        localStorage.setItem(PREF_BUCKET_IDS, JSON.stringify(currentSelection));
        if(checkbox.checked) checkbox.parentElement.classList.add('selected'); else checkbox.parentElement.classList.remove('selected');
    }

    function showVolumeCheck() { volumeHud.classList.remove('hidden'); setTimeout(() => { volumeHud.classList.add('hidden'); }, 3000); }
    function log(msg, isError = false) {
        const div = document.createElement('div');
        div.className = isError ? 'log-entry log-error' : 'log-entry';
        div.innerText = `[${new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}] ${msg}`;
        logArea.prepend(div);
    }
    
    function syncToggles() { soundToggle.checked = soundToggleActive.checked; }
    soundToggle.addEventListener('change', () => soundToggleActive.checked = soundToggle.checked);

    window.addEventListener('beforeinstallprompt', (e) => { e.preventDefault(); deferredPrompt = e; installBtn.classList.remove('hidden'); });
    async function installApp() {
        if (!deferredPrompt) return; deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') { installBtn.classList.add('hidden'); } deferredPrompt = null;
    }
    window.addEventListener('appinstalled', () => { installBtn.classList.add('hidden'); });
    document.addEventListener('visibilitychange', async () => { if (wakeLock !== null && document.visibilityState === 'visible') requestWakeLock(); });
</script>
</body>
</html>